<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>–ì—Ä–∞—Ñ—ñ–∫ —Ä–æ–±–æ—Ç–∏ ‚Äî UG Call Centre</title>

<style>
:root{
  --bg1:#f6f8fc;--bg2:#eef3fb;--grid:#cfd7e6;
  --text:#0b1220;--muted:#4b5b78;

  --pill-purple:#b88cff;--pill-green:#69d27d;
  --pill-blue:#5aa7ff;--pill-yellow:#ffd95a;
  --pill-orange:#ffb155;

  --pill-reserve:#e6f2ef;
  --pill-reserve-border:#b7d8cf;
  --pill-reserve-text:#2f5f55;

  --card:#fff;
  --soft:#f7f9fd;
  --accent:#0b1220;

  --sen-accent:#0b6bff;
  --sen-soft:#e6f7ff;
  --sen-border:#5aa7ff;
}

*{box-sizing:border-box}
body{
  margin:0;
  background:linear-gradient(135deg,var(--bg1),var(--bg2));
  font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  padding:10px;
  color:var(--text)
}
.wrap{max-width:1200px;margin:auto}
.header{display:flex;justify-content:space-between;flex-wrap:wrap;margin-bottom:8px}
h1{font-size:16px;margin:0}
.hint{font-size:11px;color:var(--muted)}

.legend-top{
  background:var(--card);
  border:1px solid var(--grid);
  border-radius:12px;
  padding:6px 10px;
  display:flex;gap:8px;flex-wrap:wrap;
  font-size:11px;color:var(--muted);
  margin-bottom:8px
}

.card{
  background:var(--card);
  border:1px solid var(--grid);
  border-radius:14px;
  margin-bottom:12px;
  overflow:hidden
}
.topbar{
  display:flex;
  justify-content:space-between;
  gap:8px;
  flex-wrap:wrap;
  padding:8px;
  background:var(--soft)
}
.controls{display:flex;gap:6px;flex-wrap:wrap}
.btn{
  padding:6px 9px;
  border-radius:10px;
  border:1px solid var(--grid);
  background:#fff;
  font-weight:900;
  font-size:12px;
  cursor:pointer
}
.btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.btn.purple{background:var(--sen-accent);border-color:var(--sen-accent);color:#fff}

.stats{display:flex;gap:10px;font-size:12px;font-weight:900;align-items:center}

.table-wrap{overflow:auto;max-height:60vh}
table{width:100%;border-collapse:separate;border-spacing:0;min-width:900px}
th,td{border-right:1px solid var(--grid);border-bottom:1px solid var(--grid);padding:5px;vertical-align:top}
th{background:#f2f5fb;font-size:12px;position:sticky;top:0;z-index:2}
.sticky-col{position:sticky;left:0;background:#f7f9fd;font-weight:900;z-index:3}

.dow{display:block;font-size:10px;color:var(--muted)}

.cell{display:flex;flex-direction:column;gap:4px}
.pills{display:flex;gap:4px;flex-wrap:wrap}
.pill{padding:3px 6px;border-radius:999px;font-size:11px;font-weight:900}
.green{background:var(--pill-green)}
.orange{background:var(--pill-orange)}
.purple{background:var(--pill-purple)}
.blue{background:var(--pill-blue)}
.yellow{background:var(--pill-yellow)}

/* ‚≠ê –°—Ç–∞—Ä—à–∞ ‚Äî –ª–∞–∑—É—Ä–Ω–∞ –ø–ª–∞—à–∫–∞ */
.pill.senior{
  background: linear-gradient(135deg, #b9f1ff, #5aa7ff);
  border: 1px solid #5aa7ff;
  color: #003a5c;
  box-shadow: 0 4px 10px rgba(90,167,255,.35);
}

/* üõü –ó–∞–ø–∞—Å ‚Äî –Ω–µ–Ω–∞–≤‚Äô—è–∑—á–∏–≤–∞ –º‚Äô—è—Ç–Ω–æ-—Å—ñ—Ä–∞ */
.pill.reserve{
  background: var(--pill-reserve);
  border: 1px solid var(--pill-reserve-border);
  color: var(--pill-reserve-text);
}

select{font-size:11px;padding:4px;border-radius:10px;border:1px solid var(--grid)}
.timeSel{max-width:90px}

/* ‚úèÔ∏è */
.edit-btn{
  display:none;
  width:26px;height:26px;
  border-radius:999px;
  border:1px solid var(--grid);
  background:#fff;
  font-weight:900;
  font-size:13px;
  line-height:24px;
  text-align:center;
  cursor:pointer;
  padding:0;
  user-select:none;
}
.cell.compact select,
.cell.compact .timeSel{display:none !important}
.cell.compact .edit-btn{display:inline-block}
.cell.compact[data-has="0"] .edit-btn{display:none}

/* –°—Ç–∞—Ä—à—ñ ‚Äî –≤–∏–¥—ñ–ª–µ–Ω–Ω—è */
.senior-card{
  border:2px solid var(--sen-border);
  box-shadow:0 10px 30px rgba(90,167,255,.20);
}
.senior-card .topbar{
  background:linear-gradient(135deg,var(--sen-soft), #ffffff);
}
.senior-card th{background:#eaf6ff}
.senior-card .sticky-col{background:#f1f9ff}

/* –õ—ñ—á–∏–ª—å–Ω–∏–∫–∏ –ø–æ –¥–Ω—è—Ö */
.day-count{
  margin-top:4px;
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  font-size:10px;
  color:var(--muted);
}
.day-badge{
  border:1px solid var(--grid);
  background:#fff;
  border-radius:999px;
  padding:2px 6px;
  font-weight:900;
  white-space:nowrap;
}
.day-badge .g{color:#0b6b2a}
.day-badge .p{color:#6a2cff}

/* PNG */
.png-wrap{background:#fff;padding:12px;width:1200px}
.png-title{font-weight:900;font-size:16px;margin:0 0 8px 0}
.png-sub{margin:0 0 10px 0;font-size:12px;color:var(--muted)}
</style>
</head>

<body>
<div class="wrap">

<div class="header">
  <div>
    <h1>–ì—Ä–∞—Ñ—ñ–∫ —Ä–æ–±–æ—Ç–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ñ–≤</h1>
    <div class="hint">UG Call Centre (—Å–ø—ñ–ª—å–Ω–∏–π –≥—Ä–∞—Ñ—ñ–∫ —á–µ—Ä–µ–∑ Google Sheets)</div>
  </div>
</div>

<div class="legend-top">
  <b>–°—Ç–∞—Ç—É—Å–∏:</b>
  üü¢ –†–æ–±–æ—á–∏–π ¬∑ üü£ –í–∏—Ö—ñ–¥–Ω–∏–π ¬∑ üîµ –ú–æ–∂–ª–∏–≤–æ ¬∑ üü° –•–≤–æ—Ä—ñ—î ¬∑ ‚≠ê –°—Ç–∞—Ä—à–∞ ¬∑ üõü –û–ø–µ—Ä–∞—Ç–æ—Ä –∑–∞–ø–∞—Å—É
</div>

<div class="card">
  <div class="topbar">
    <div class="controls">
      <button class="btn" id="btnThisWeek">–¶–µ–π —Ç–∏–∂–¥–µ–Ω—å</button>
      <button class="btn" id="btnNextWeek">–ù–∞—Å—Ç—É–ø–Ω–∏–π —Ç–∏–∂–¥–µ–Ω—å</button>
      <button class="btn" id="btnAddOp">+ –û–ø–µ—Ä–∞—Ç–æ—Ä</button>
      <button class="btn" id="btnDelOp">‚àí –û–ø–µ—Ä–∞—Ç–æ—Ä</button>
      <button class="btn" id="btnClear">–û—á–∏—Å—Ç–∏—Ç–∏</button>
      <button class="btn" id="btnExport">Excel</button>
      <button class="btn purple" id="btnTGTomorrowShot">TG: –∑–∞–≤—Ç—Ä–∞ (PNG)</button>
      <button class="btn primary" id="btnTGWeekShot">TG: —Ç–∏–∂–¥–µ–Ω—å (PNG)</button>
      <button class="btn" id="btnCompact">–†–µ–∂–∏–º: —Ç—ñ–ª—å–∫–∏ –≤–∏–±—Ä–∞–Ω–µ</button>
    </div>
    <div class="stats" id="stats">üü¢0 | üü£0 | üü°0 | üîµ0 | üõü0</div>
  </div>
</div>

<div class="card senior-card">
  <div class="topbar"><b>–°—Ç–∞—Ä—à—ñ –∑–º—ñ–Ω–∏</b></div>
  <div class="table-wrap">
    <table>
      <thead>
        <tr id="seniorHead"><th class="sticky-col">–°—Ç–∞—Ä—à–∏–π</th></tr>
      </thead>
      <tbody id="seniorBody"></tbody>
    </table>
  </div>
</div>

<div class="card" id="operatorsCard">
  <div class="topbar"><b>–û–ø–µ—Ä–∞—Ç–æ—Ä–∏</b></div>
  <div class="table-wrap">
    <table>
      <thead>
        <tr id="opHead"><th class="sticky-col">–û–ø–µ—Ä–∞—Ç–æ—Ä</th></tr>
      </thead>
      <tbody id="opBody"></tbody>
    </table>
  </div>
</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
/* ===================== GOOGLE SHEETS API ===================== */
const API_URL = "https://script.google.com/macros/s/AKfycbw3EXZx91Fg7Jp5CgtX9veWph5qpmd0NY1uDTjGh6mFEnzGE2g0tc5Er-uC73-M0uVa0w/exec";
const API_TOKEN = ""; // —É —Ç–µ–±–µ —Ç–æ–∫–µ–Ω –≤–∏–º–∫–Ω–µ–Ω–∏–π
const SHARED_KEY = "ug_schedule_shared_v1";

async function apiLoadShared(){
  const url = `${API_URL}?action=load&key=${encodeURIComponent(SHARED_KEY)}&token=${encodeURIComponent(API_TOKEN)}`;
  const r = await fetch(url);
  const j = await r.json();
  if(!j.ok) throw new Error(j.error || "API load error");
  return j.value ? JSON.parse(j.value) : null;
}

/* –í–ê–ñ–õ–ò–í–û: form-urlencoded POST (—â–æ–± GitHub Pages –∑–±–µ—Ä—ñ–≥–∞–≤ –±–µ–∑ CORS –ø—Ä–æ–±–ª–µ–º) */
let saveTimer = null;
async function apiSaveShared(data){
  if(saveTimer) clearTimeout(saveTimer);
  return new Promise((resolve,reject)=>{
    saveTimer = setTimeout(async ()=>{
      try{
        const form = new URLSearchParams();
        form.set("action","save");
        form.set("key",SHARED_KEY);
        form.set("token",API_TOKEN);
        form.set("value", JSON.stringify(data));

        const r = await fetch(API_URL, {
          method:"POST",
          body: form,
          redirect:"follow"
        });
        const j = await r.json();
        if(!j.ok) throw new Error(j.error || "API save error");
        resolve(true);
      }catch(e){ reject(e); }
    }, 350);
  });
}

/* ===================== CONFIG ===================== */
const SENIORS=["–ö—É–∫—É—Ä—É–¥–∑–∞ –í—ñ–∫—Ç–æ—Ä—ñ—è","–ú–∏—Ö–∞–π–ª–æ–≤–∞ –ö–∞—Ç–µ—Ä–∏–Ω–∞"];
const DEFAULT_OPERATORS=[
  "–ë–æ—Ä–æ–¥—ñ–Ω –ö–∏—Ä–∏–ª","–í–µ—Ä–µ—â–∞–∫ –ú–∞—Ä–∏–Ω–∞","–ì–∞—Ä–∞—Å–∏–º—á—É–∫ –û–ª–µ–≥","–ì–æ—Ä–±–∞—Ç—é–∫ –û–ª–µ–≥",
  "–ì—Ä–∏—Ü–µ–Ω–∫–æ –ê–Ω–∞—Å—Ç–∞—Å—ñ—è","–ñ–∞–ª–æ–≤–∞–≥–∞ –¢–µ—Ç—è–Ω–∞","–ö–∞–ª–æ—à–∏–Ω –ê–ª—å–æ–Ω–∞","–ö–ª–æ–ø–æ—Ç—é–∫ –û–ª—å–≥–∞",
  "–ö—É–ª–µ–Ω–∫–æ –ú–∞—Ä–∏–Ω–∞","–ú–∞—Ä–º–æ–Ω—Ç–æ–≤–∞ –ê–ª—ñ—Å–∞","–ú–∞—Ä—Ç–∏–Ω—é–∫ –í—ñ–∫—Ç–æ—Ä","–ú–æ—Ä–æ–∑–æ–≤–∞ –¢–µ—Ç—è–Ω–∞",
  "–°–∞–ª—ñ–π –Æ–ª—ñ—è","–°—Ç–µ–ø–∞–Ω—é–∫ –í—ñ–∫–∞","–¢—Ä—É—à –°–≤—ñ—Ç–ª–∞–Ω–∞","–ß–∞–π–∫–æ–≤—Å—å–∫–∞ –î—ñ–∞–Ω–∞",
  "–®–µ—Å—Ç–∞–∫–∞ –î–º–∏—Ç—Ä–æ","–†—É–¥–æ–≤–∞ –Ø–Ω–∞","–ì—É–∫–∞–ª—é–∫ –î—ñ–∞–Ω–∞","–õ–æ–∑–∏–Ω—Å—å–∫–∞ –Æ–ª—ñ—è",
  "–®–∫–æ–¥–∞ –û–ª—å–≥–∞","–ß—É–±—ñ–Ω–∞—à–≤—ñ–ª—ñ –¢–µ—Ç—è–Ω–∞","–ê—Ä—Ç–µ–º–∏—á–µ–Ω–∫–æ –ù—ñ–Ω–∞","–®–∞–ª–µ–≤–∞ –ê–Ω–∞—Å—Ç–∞—Å—ñ—è"
];
const DOW=["–ø–Ω","–≤—Ç","—Å—Ä","—á—Ç","–ø—Ç","—Å–±","–Ω–¥"];

const STATUS={WORK:"work",OFF:"off",POSSIBLE:"possible",SICK:"sick",RESERVE:"reserve"};
const LABELS={"":"–û–±—Ä–∞—Ç–∏",work:"–†–æ–±–æ—á–∏–π",off:"–í–∏—Ö—ñ–¥–Ω–∏–π",possible:"–ú–æ–∂–ª–∏–≤–æ",sick:"–•–≤–æ—Ä—ñ—î",reserve:"–û–ø–µ—Ä–∞—Ç–æ—Ä –∑–∞–ø–∞—Å—É"};

const SEN_STATUS={SENIOR:"senior",WORK:"work",OFF:"off"};
const SEN_LABELS={"":"–û–±—Ä–∞—Ç–∏",senior:"–°—Ç–∞—Ä—à–∞",work:"–†–æ–±–æ—á–∏–π",off:"–í–∏—Ö—ñ–¥–Ω–∏–π"};

const TIMES=[...Array(13)].map((_,i)=>String(i+9).padStart(2,"0")+":00");

const LS_OP="ug_ops_state";
const LS_SEN="ug_sen_state";
const LS_OPLIST="ug_ops_list";
const LS_WEEK="ug_week_start";
const LS_COMPACT="ug_compact_mode";

let SHARED=null;

/* ===================== DATE ===================== */
function startOfWeek(d){
  d=new Date(d);
  const day=d.getDay()||7;
  d.setDate(d.getDate()-day+1);
  d.setHours(0,0,0,0);
  return d;
}
function addDays(d,n){const x=new Date(d);x.setDate(x.getDate()+n);return x}
function fmt(d){return String(d.getDate()).padStart(2,"0")+"."+String(d.getMonth()+1).padStart(2,"0")}
function fmtISO(d){return d.toISOString().slice(0,10)}

let currentWeekStart = (()=>{
  const saved = localStorage.getItem(LS_WEEK);
  if(saved){
    const d=new Date(saved);
    if(!isNaN(d)) return startOfWeek(d);
  }
  return startOfWeek(new Date());
})();
function setWeekStart(d){
  currentWeekStart=startOfWeek(d);
  localStorage.setItem(LS_WEEK,currentWeekStart.toISOString());
  renderAll();
  syncToGoogle();
}

/* ===================== STORAGE ===================== */
function load(k){try{return JSON.parse(localStorage.getItem(k))||{}}catch{return{}}}
function save(k,v){localStorage.setItem(k,JSON.stringify(v))}

/* ===================== COMPACT ===================== */
function isCompact(){ return localStorage.getItem(LS_COMPACT)==="1"; }
function setCompact(v){
  localStorage.setItem(LS_COMPACT, v ? "1":"0");
  renderAll();
  syncToGoogle();
}
function applyCompactToCell(cellEl, hasValue){
  if(isCompact()) cellEl.classList.add("compact"); else cellEl.classList.remove("compact");
  cellEl.dataset.has = hasValue ? "1" : "0";
}

/* ===================== UI HELPERS ===================== */
function pillHTML(d, mode="op"){
  if(!d?.type) return "";
  if(mode==="sen"){
    if(d.type===SEN_STATUS.OFF) return `<span class="pill purple">–í–∏—Ö—ñ–¥–Ω–∏–π</span>`;
    if(d.type===SEN_STATUS.SENIOR) return `<span class="pill senior">‚≠ê –°—Ç–∞—Ä—à–∞</span><span class="pill orange">${d.start}‚Äì${d.end}</span>`;
    if(d.type===SEN_STATUS.WORK) return `<span class="pill green">–†–æ–±–æ—á–∏–π</span><span class="pill orange">${d.start}‚Äì${d.end}</span>`;
    return "";
  }
  if(d.type===STATUS.OFF) return `<span class="pill purple">–í–∏—Ö—ñ–¥–Ω–∏–π</span>`;
  if(d.type===STATUS.SICK) return `<span class="pill yellow">–•–≤–æ—Ä—ñ—î</span>`;
  if(d.type===STATUS.POSSIBLE) return `<span class="pill blue">–ú–æ–∂–ª–∏–≤–æ</span>`;
  if(d.type===STATUS.RESERVE) return `<span class="pill reserve">üõü –ó–∞–ø–∞—Å</span>`;
  if(d.type===STATUS.WORK) return `<span class="pill green">–†–æ–±–æ—á–∏–π</span><span class="pill orange">${d.start}‚Äì${d.end}</span>`;
  return "";
}

function statusSelect(val, mode="op"){
  const s=document.createElement("select");
  const list = (mode==="sen")
    ? ["",SEN_STATUS.SENIOR,SEN_STATUS.WORK,SEN_STATUS.OFF]
    : ["",STATUS.WORK,STATUS.OFF,STATUS.POSSIBLE,STATUS.SICK,STATUS.RESERVE];
  const labels = (mode==="sen") ? SEN_LABELS : LABELS;

  list.forEach(v=>{
    const o=document.createElement("option");
    o.value=v; o.textContent=labels[v]||v;
    if(v===val) o.selected=true;
    if(v==="") o.disabled=true;
    s.appendChild(o);
  });
  return s;
}

function timeSelect(v){
  const s=document.createElement("select");
  s.className="timeSel";
  TIMES.forEach(t=>{
    const o=document.createElement("option");
    o.value=t; o.textContent=t;
    if(t===v) o.selected=true;
    s.appendChild(o);
  });
  return s;
}

/* ===================== TABLE STATE ===================== */
function getCell(state,key,i,d){return state[key]?.[i]?.[d]||{}}
function setCell(state,key,i,d,val){
  state[key]=state[key]||{};
  state[key][i]=state[key][i]||{};
  state[key][i][d]=val;
}

/* ===================== COUNTS + HEAD ===================== */
function dayCountsFor(mode){
  const key=fmtISO(currentWeekStart);
  let names, lsKey;
  if(mode==="sen"){ names=SENIORS; lsKey=LS_SEN; }
  else { names=JSON.parse(localStorage.getItem(LS_OPLIST))||DEFAULT_OPERATORS; lsKey=LS_OP; }

  const state=load(lsKey);
  const counts=Array.from({length:7},()=>({work:0,off:0}));

  names.forEach((_,i)=>{
    for(let d=0;d<7;d++){
      const c=getCell(state,key,i,d);
      if(!c?.type) continue;

      if(mode==="sen"){
        if(c.type===SEN_STATUS.SENIOR || c.type===SEN_STATUS.WORK) counts[d].work++;
        if(c.type===SEN_STATUS.OFF) counts[d].off++;
      }else{
        if(c.type===STATUS.WORK) counts[d].work++;
        if(c.type===STATUS.OFF) counts[d].off++;
        // possible/sick/reserve ‚Äî –Ω–µ —Ä–∞—Ö—É—î–º–æ –≤ —Ü–∏—Ö –¥–≤–æ—Ö
      }
    }
  });
  return counts;
}

function buildHead(row, counts){
  row.innerHTML='<th class="sticky-col">'+(row.id==="seniorHead"?"–°—Ç–∞—Ä—à–∏–π":"–û–ø–µ—Ä–∞—Ç–æ—Ä")+'</th>';
  for(let i=0;i<7;i++){
    const c=counts?.[i]||{work:0,off:0};
    const th=document.createElement("th");
    th.innerHTML=`
      ${fmt(addDays(currentWeekStart,i))}
      <span class="dow">${DOW[i]}</span>
      <div class="day-count">
        <span class="day-badge"><span class="g">üü¢</span> ${c.work}</span>
        <span class="day-badge"><span class="p">üü£</span> ${c.off}</span>
      </div>`;
    row.appendChild(th);
  }
}

/* ===================== RENDER TABLE ===================== */
function renderTable(headId,bodyId,names,lsKey,mode="op"){
  const state=load(lsKey);
  const key=fmtISO(currentWeekStart);
  const counts=dayCountsFor(mode);

  buildHead(document.getElementById(headId), counts);
  const body=document.getElementById(bodyId);
  body.innerHTML="";

  names.forEach((name,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td class="sticky-col">${name}</td>`;

    for(let d=0;d<7;d++){
      const td=document.createElement("td");
      const cell=document.createElement("div"); cell.className="cell";
      const data=getCell(state,key,i,d);
      const hasValue=!!data?.type;

      const pills=document.createElement("div");
      pills.className="pills";
      pills.innerHTML=pillHTML(data, mode);

      const editBtn=document.createElement("button");
      editBtn.className="edit-btn";
      editBtn.textContent="‚úèÔ∏è";
      editBtn.onclick=()=>{
        cell.classList.remove("compact");
        sel.style.display="";
        sync();
      };

      const sel=statusSelect(data.type||"", mode);
      const st=timeSelect(data.start||"09:00");
      const en=timeSelect(data.end||"21:00");

      function sync(){
        const v=sel.value;
        if(mode==="sen"){
          const on=(v===SEN_STATUS.SENIOR||v===SEN_STATUS.WORK);
          st.style.display=en.style.display=on?"":"none";
        }else{
          const on=(v===STATUS.WORK);
          st.style.display=en.style.display=on?"":"none";
        }
      }

      function saveCellNow(){
        const v=sel.value; if(!v) return;

        if(mode==="sen"){
          if(v===SEN_STATUS.SENIOR||v===SEN_STATUS.WORK)
            setCell(state,key,i,d,{type:v,start:st.value,end:en.value});
          else
            setCell(state,key,i,d,{type:v});
        }else{
          if(v===STATUS.WORK)
            setCell(state,key,i,d,{type:v,start:st.value,end:en.value});
          else
            setCell(state,key,i,d,{type:v});
        }

        save(lsKey,state);
        renderAll();
        syncToGoogle();
      }

      sel.onchange=saveCellNow;
      st.onchange=saveCellNow;
      en.onchange=saveCellNow;

      sync();
      cell.append(pills,editBtn,sel,st,en);
      applyCompactToCell(cell,hasValue);

      td.appendChild(cell);
      tr.appendChild(td);
    }

    body.appendChild(tr);
  });
}

/* ===================== STATS ===================== */
function renderStats(){
  const key=fmtISO(currentWeekStart);
  let w=0,o=0,s=0,p=0,r=0;
  const opsState=load(LS_OP)[key]||{};
  Object.values(opsState).forEach(days=>{
    Object.values(days).forEach(d=>{
      if(!d.type) return;
      if(d.type===STATUS.WORK) w++;
      if(d.type===STATUS.OFF) o++;
      if(d.type===STATUS.SICK) s++;
      if(d.type===STATUS.POSSIBLE) p++;
      if(d.type===STATUS.RESERVE) r++;
    });
  });
  document.getElementById("stats").textContent=`üü¢${w} | üü£${o} | üü°${s} | üîµ${p} | üõü${r}`;
}

function renderAll(){
  const ops=JSON.parse(localStorage.getItem(LS_OPLIST))||DEFAULT_OPERATORS;
  renderTable("seniorHead","seniorBody",SENIORS,LS_SEN,"sen");
  renderTable("opHead","opBody",ops,LS_OP,"op");
  renderStats();
  document.getElementById("btnCompact").textContent =
    isCompact() ? "–†–µ–∂–∏–º: —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è" : "–†–µ–∂–∏–º: —Ç—ñ–ª—å–∫–∏ –≤–∏–±—Ä–∞–Ω–µ";
}

/* ===================== SYNC TO GOOGLE ===================== */
async function syncToGoogle(){
  const data = {
    weekStart: localStorage.getItem(LS_WEEK) || null,
    opsList: JSON.parse(localStorage.getItem(LS_OPLIST) || "null"),
    opsState: load(LS_OP),
    senState: load(LS_SEN),
    compact: localStorage.getItem(LS_COMPACT) || "0"
  };
  SHARED = data;
  try{
    await apiSaveShared(data);
  }catch(e){
    console.warn("Google save error:", e);
  }
}

function localSnapshot(){
  return JSON.stringify({
    weekStart: localStorage.getItem(LS_WEEK) || null,
    opsList: JSON.parse(localStorage.getItem(LS_OPLIST) || "null"),
    opsState: load(LS_OP),
    senState: load(LS_SEN),
    compact: localStorage.getItem(LS_COMPACT) || "0"
  });
}

async function applyShared(shared){
  if(shared.weekStart) localStorage.setItem(LS_WEEK, shared.weekStart);
  if(shared.opsList) localStorage.setItem(LS_OPLIST, JSON.stringify(shared.opsList));
  save(LS_OP, shared.opsState || {});
  save(LS_SEN, shared.senState || {});
  localStorage.setItem(LS_COMPACT, String(shared.compact ?? "0"));

  const ws = localStorage.getItem(LS_WEEK);
  if(ws){
    const d = new Date(ws);
    if(!isNaN(d)) currentWeekStart = startOfWeek(d);
  }
  renderAll();
}

/* ===================== BUTTONS ===================== */
document.getElementById("btnCompact").onclick=()=>setCompact(!isCompact());
document.getElementById("btnThisWeek").onclick=()=>setWeekStart(new Date());
document.getElementById("btnNextWeek").onclick=()=>{
  const thisMon=startOfWeek(new Date());
  setWeekStart(addDays(thisMon,7));
};

document.getElementById("btnAddOp").onclick=()=>{
  const n=prompt("–ü–Ü–ë –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞:");
  if(!n) return;
  const ops=JSON.parse(localStorage.getItem(LS_OPLIST))||DEFAULT_OPERATORS;
  ops.push(n.trim());
  localStorage.setItem(LS_OPLIST,JSON.stringify(ops));
  renderAll();
  syncToGoogle();
};

document.getElementById("btnDelOp").onclick=()=>{
  const ops=JSON.parse(localStorage.getItem(LS_OPLIST))||DEFAULT_OPERATORS;
  const list=ops.map((n,i)=>`${i+1}. ${n}`).join("\n");
  const v=parseInt(prompt("–ö–æ–≥–æ –≤–∏–¥–∞–ª–∏—Ç–∏?\n"+list))-1;
  if(v>=0){
    ops.splice(v,1);
    localStorage.setItem(LS_OPLIST,JSON.stringify(ops));
    renderAll();
    syncToGoogle();
  }
};

document.getElementById("btnClear").onclick=()=>{
  save(LS_OP,{});
  save(LS_SEN,{});
  renderAll();
  syncToGoogle();
};

/* ===================== EXCEL EXPORT ===================== */
document.getElementById("btnExport").onclick=()=>{
  const wb=XLSX.utils.book_new();
  const wk=fmtISO(currentWeekStart);

  // Seniors
  {
    const st=load(LS_SEN);
    const rows=[["–Ü–º'—è",...DOW.map((_,i)=>fmt(addDays(currentWeekStart,i)))]];
    SENIORS.forEach((n,i)=>{
      const r=[n];
      for(let d=0;d<7;d++){
        const c=getCell(st,wk,i,d);
        if(c.type===SEN_STATUS.SENIOR) r.push(`–°—Ç–∞—Ä—à–∞ ${c.start}-${c.end}`);
        else if(c.type===SEN_STATUS.WORK) r.push(`–†–æ–±–æ—á–∏–π ${c.start}-${c.end}`);
        else if(c.type===SEN_STATUS.OFF) r.push("–í–∏—Ö—ñ–¥–Ω–∏–π");
        else r.push("");
      }
      rows.push(r);
    });
    XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(rows),"–°—Ç–∞—Ä—à—ñ");
  }

  // Operators
  {
    const names=JSON.parse(localStorage.getItem(LS_OPLIST))||DEFAULT_OPERATORS;
    const st=load(LS_OP);
    const rows=[["–Ü–º'—è",...DOW.map((_,i)=>fmt(addDays(currentWeekStart,i)))]];
    names.forEach((n,i)=>{
      const r=[n];
      for(let d=0;d<7;d++){
        const c=getCell(st,wk,i,d);
        if(c.type===STATUS.WORK) r.push(`–†–æ–±–æ—á–∏–π ${c.start}-${c.end}`);
        else if(c.type===STATUS.OFF) r.push("–í–∏—Ö—ñ–¥–Ω–∏–π");
        else if(c.type===STATUS.SICK) r.push("–•–≤–æ—Ä—ñ—î");
        else if(c.type===STATUS.POSSIBLE) r.push("–ú–æ–∂–ª–∏–≤–æ");
        else if(c.type===STATUS.RESERVE) r.push("–û–ø–µ—Ä–∞—Ç–æ—Ä –∑–∞–ø–∞—Å—É");
        else r.push("");
      }
      rows.push(r);
    });
    XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(rows),"–û–ø–µ—Ä–∞—Ç–æ—Ä–∏");
  }

  XLSX.writeFile(wb,"UG_Schedule.xlsx");
};

/* ===================== PNG EXPORT (TG) ===================== */
function dayIndexTomorrow(){
  const t=new Date(); t.setDate(t.getDate()+1);
  return (t.getDay()||7)-1;
}
function downloadDataUrl(dataUrl, filename){
  const a=document.createElement("a");
  a.href=dataUrl; a.download=filename; a.click();
}

function cloneCardsForPng({mode="week",dayIndex=0}){
  const tmp=document.createElement("div");
  tmp.className="png-wrap";
  tmp.style.position="fixed";
  tmp.style.left="-99999px";
  tmp.style.top="0";

  const title=document.createElement("p"); title.className="png-title";
  const sub=document.createElement("p"); sub.className="png-sub";

  if(mode==="day"){
    title.textContent="UG Call Centre ‚Äî –ì—Ä–∞—Ñ—ñ–∫ –Ω–∞ –∑–∞–≤—Ç—Ä–∞";
    sub.textContent=`–î–∞—Ç–∞: ${fmt(addDays(currentWeekStart,dayIndex))} (${DOW[dayIndex]})`;
  }else{
    title.textContent="UG Call Centre ‚Äî –ì—Ä–∞—Ñ—ñ–∫ –Ω–∞ —Ç–∏–∂–¥–µ–Ω—å";
    sub.textContent=`–ü–µ—Ä—ñ–æ–¥: ${fmt(currentWeekStart)}‚Äì${fmt(addDays(currentWeekStart,6))}`;
  }
  tmp.append(title,sub);

  const senClone=document.querySelector(".senior-card").cloneNode(true);
  const opClone=document.getElementById("operatorsCard").cloneNode(true);

  senClone.querySelectorAll("select,.timeSel,.edit-btn").forEach(el=>el.remove());
  opClone.querySelectorAll("select,.timeSel,.edit-btn").forEach(el=>el.remove());

  tmp.append(senClone, opClone);

  tmp.querySelectorAll(".table-wrap").forEach(w=>{w.style.maxHeight="none"; w.style.overflow="visible";});
  tmp.querySelectorAll("th,.sticky-col").forEach(el=>{el.style.position="static";});

  if(mode==="day"){
    tmp.querySelectorAll("table").forEach(tbl=>{
      tbl.querySelectorAll("tr").forEach(r=>{
        Array.from(r.children).forEach((c,idx)=>{
          if(idx===0) return;
          if(idx-1!==dayIndex) c.style.display="none";
        });
      });
    });
  }

  document.body.appendChild(tmp);
  return tmp;
}

async function exportPngTomorrow(){
  const d=dayIndexTomorrow();
  const tmp=cloneCardsForPng({mode:"day",dayIndex:d});
  const canvas=await html2canvas(tmp,{scale:2,backgroundColor:"#fff"});
  document.body.removeChild(tmp);
  downloadDataUrl(canvas.toDataURL("image/png"),`UG_–ó–∞–≤—Ç—Ä–∞_${fmt(addDays(currentWeekStart,d)).replaceAll(".","-")}.png`);
}
async function exportPngWeek(){
  const tmp=cloneCardsForPng({mode:"week"});
  const canvas=await html2canvas(tmp,{scale:2,backgroundColor:"#fff"});
  document.body.removeChild(tmp);
  downloadDataUrl(canvas.toDataURL("image/png"),`UG_–¢–∏–∂–¥–µ–Ω—å_${fmt(currentWeekStart).replaceAll(".","-")}_${fmt(addDays(currentWeekStart,6)).replaceAll(".","-")}.png`);
}

document.getElementById("btnTGTomorrowShot").onclick=()=>exportPngTomorrow();
document.getElementById("btnTGWeekShot").onclick=()=>exportPngWeek();

/* ===================== START ===================== */
(async ()=>{
  try{
    SHARED = await apiLoadShared();
  }catch(e){
    console.warn("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑ Google. –ü—Ä–∞—Ü—é—é –ª–æ–∫–∞–ª—å–Ω–æ.", e);
    SHARED = null;
  }

  if(!SHARED){
    SHARED = {
      weekStart: localStorage.getItem(LS_WEEK) || startOfWeek(new Date()).toISOString(),
      opsList: JSON.parse(localStorage.getItem(LS_OPLIST) || "null") || DEFAULT_OPERATORS,
      opsState: load(LS_OP),
      senState: load(LS_SEN),
      compact: localStorage.getItem(LS_COMPACT) || "0"
    };
    try{ await apiSaveShared(SHARED); }catch(e){ console.warn(e); }
  }

  await applyShared(SHARED);

  // –∞–≤—Ç–æ–æ–Ω–æ–≤–ª–µ–Ω–Ω—è (—â–æ–± –≤—Å—ñ –±–∞—á–∏–ª–∏ –∑–º—ñ–Ω–∏)
  setInterval(async ()=>{
    try{
      const latest = await apiLoadShared();
      if(!latest) return;
      const nowStr = localSnapshot();
      const latestStr = JSON.stringify(latest);
      if(latestStr !== nowStr){
        await applyShared(latest);
      }
    }catch(e){
      // —Ç–∏—Ö–æ
    }
  }, 10000);
})();
</script>
</body>
</html>
